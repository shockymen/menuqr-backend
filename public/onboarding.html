<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to MenuQR Africa</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#D4AF37',
                        secondary: '#1a1a1a',
                    }
                }
            }
        }
    </script>
    
    <style>
        .step-indicator {
            transition: all 0.3s ease;
        }
        
        .step-indicator.active {
            background: linear-gradient(135deg, #D4AF37 0%, #F4D03F 100%);
            transform: scale(1.1);
        }
        
        .step-indicator.completed {
            background: #10b981;
        }
        
        .step-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .step-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-amber-50 via-white to-orange-50 min-h-screen">
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Config -->
    <script src="config.js"></script>
    
    <!-- Auth Utils -->
    <script src="auth-utils.js"></script>
    
    <!-- ROUTE PROTECTION - Enforce gates BEFORE showing page -->
    <script>
        (async function() {
            try {
                // Enforce gates 1 & 2 (authenticated + complete profile)
                // Gate 3 (onboarding) should fail - that's why we're here!
                const { data: { user } } = await window.supabase.auth.getUser();
                
                if (!user) {
                    console.log('Not authenticated, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }
                
                const { data: profile } = await window.supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (!profile || !profile.business_name) {
                    console.log('Incomplete profile, redirecting to signup');
                    window.location.href = `signup.html?email=${user.email}&oauth=true`;
                    return;
                }
                
                // If already onboarded, go to dashboard
                if (profile.firstlogin) {
                    console.log('Already onboarded, redirecting to dashboard');
                    window.location.href = 'dashboard.html';
                    return;
                }
                
                console.log('‚úÖ Ready for onboarding');
                
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = 'login.html';
            }
        })();
    </script>
    
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold bg-gradient-to-r from-amber-600 to-orange-600 bg-clip-text text-transparent mb-2">
                Welcome to MenuQR Africa! üéâ
            </h1>
            <p class="text-gray-600">Let's get you set up in just 4 easy steps</p>
        </div>
        
        <!-- Progress Indicator -->
        <div class="flex justify-between items-center mb-12 max-w-2xl mx-auto">
            <div class="flex-1 flex items-center">
                <div id="step-1-indicator" class="step-indicator active w-10 h-10 rounded-full flex items-center justify-center text-white font-bold">1</div>
                <div class="flex-1 h-1 bg-gray-200 mx-2"></div>
            </div>
            <div class="flex-1 flex items-center">
                <div id="step-2-indicator" class="step-indicator w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 font-bold">2</div>
                <div class="flex-1 h-1 bg-gray-200 mx-2"></div>
            </div>
            <div class="flex-1 flex items-center">
                <div id="step-3-indicator" class="step-indicator w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 font-bold">3</div>
                <div class="flex-1 h-1 bg-gray-200 mx-2"></div>
            </div>
            <div>
                <div id="step-4-indicator" class="step-indicator w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 font-bold">4</div>
            </div>
        </div>
        
        <!-- Main Card -->
        <div class="bg-white rounded-2xl shadow-xl p-8 md:p-12">
            
            <!-- Step 1: Welcome -->
            <div id="step-1" class="step-content active">
                <div class="text-center">
                    <div class="text-6xl mb-6">üçΩÔ∏è</div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Welcome to Your Digital Menu Platform</h2>
                    <p class="text-lg text-gray-600 mb-8 max-w-2xl mx-auto">
                        MenuQR Africa helps restaurants, caf√©s, and hotels create beautiful digital menus accessible via QR codes. Let's get started!
                    </p>
                    
                    <div class="grid md:grid-cols-3 gap-6 mb-8">
                        <div class="p-6 bg-amber-50 rounded-xl">
                            <div class="text-3xl mb-3">üì±</div>
                            <h3 class="font-bold text-gray-800 mb-2">Scan & View</h3>
                            <p class="text-sm text-gray-600">Customers scan QR codes to access your menu instantly</p>
                        </div>
                        <div class="p-6 bg-amber-50 rounded-xl">
                            <div class="text-3xl mb-3">üåç</div>
                            <h3 class="font-bold text-gray-800 mb-2">Multi-Language</h3>
                            <p class="text-sm text-gray-600">Offer menus in multiple languages for tourists</p>
                        </div>
                        <div class="p-6 bg-amber-50 rounded-xl">
                            <div class="text-3xl mb-3">‚ö°</div>
                            <h3 class="font-bold text-gray-800 mb-2">Real-Time Updates</h3>
                            <p class="text-sm text-gray-600">Update prices and items instantly, no reprinting</p>
                        </div>
                    </div>
                    
                    <button onclick="nextStep()" class="px-8 py-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold rounded-xl hover:shadow-lg transition text-lg">
                        Let's Get Started ‚Üí
                    </button>
                </div>
            </div>
            
            <!-- Step 2: Business Setup -->
            <div id="step-2" class="step-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Tell Us About Your Business</h2>
                
                <div class="space-y-6 mb-8">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Primary Cuisine Type</label>
                        <select id="cuisine-type" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-amber-500 focus:outline-none">
                            <option value="">Select your main cuisine...</option>
                            <option value="african">African</option>
                            <option value="european">European</option>
                            <option value="asian">Asian</option>
                            <option value="american">American</option>
                            <option value="mediterranean">Mediterranean</option>
                            <option value="fusion">Fusion</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Average Price Range</label>
                        <select id="price-range" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-amber-500 focus:outline-none">
                            <option value="">Select price range...</option>
                            <option value="budget">Budget (‚Çµ - Under ‚Çµ50 per person)</option>
                            <option value="moderate">Moderate (‚Çµ‚Çµ - ‚Çµ50-‚Çµ150 per person)</option>
                            <option value="upscale">Upscale (‚Çµ‚Çµ‚Çµ - ‚Çµ150-‚Çµ300 per person)</option>
                            <option value="fine-dining">Fine Dining (‚Çµ‚Çµ‚Çµ‚Çµ - Over ‚Çµ300 per person)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Number of Menu Items (Approximate)</label>
                        <select id="menu-size" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-amber-500 focus:outline-none">
                            <option value="">Select range...</option>
                            <option value="small">Small (1-25 items)</option>
                            <option value="medium">Medium (26-75 items)</option>
                            <option value="large">Large (76-150 items)</option>
                            <option value="xlarge">Extra Large (150+ items)</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex gap-4">
                    <button onclick="prevStep()" class="px-6 py-3 border-2 border-gray-300 text-gray-700 font-bold rounded-xl hover:bg-gray-50 transition">
                        ‚Üê Back
                    </button>
                    <button onclick="nextStep()" class="flex-1 px-6 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold rounded-xl hover:shadow-lg transition">
                        Continue ‚Üí
                    </button>
                </div>
            </div>
            
            <!-- Step 3: Features -->
            <div id="step-3" class="step-content">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">What Features Interest You Most?</h2>
                <p class="text-gray-600 mb-6">Select all that apply (you can change this later)</p>
                
                <div class="grid md:grid-cols-2 gap-4 mb-8">
                    <label class="flex items-start p-4 border-2 border-gray-200 rounded-xl hover:border-amber-500 cursor-pointer transition">
                        <input type="checkbox" id="feature-multilang" class="mt-1 mr-3" value="multilang">
                        <div>
                            <div class="font-bold text-gray-800">üåç Multi-Language Menus</div>
                            <div class="text-sm text-gray-600">Serve international customers</div>
                        </div>
                    </label>
                    
                    <label class="flex items-start p-4 border-2 border-gray-200 rounded-xl hover:border-amber-500 cursor-pointer transition">
                        <input type="checkbox" id="feature-allergens" class="mt-1 mr-3" value="allergens">
                        <div>
                            <div class="font-bold text-gray-800">‚ö†Ô∏è Allergen Information</div>
                            <div class="text-sm text-gray-600">Label dietary restrictions</div>
                        </div>
                    </label>
                    
                    <label class="flex items-start p-4 border-2 border-gray-200 rounded-xl hover:border-amber-500 cursor-pointer transition">
                        <input type="checkbox" id="feature-photos" class="mt-1 mr-3" value="photos">
                        <div>
                            <div class="font-bold text-gray-800">üì∏ High-Quality Photos</div>
                            <div class="text-sm text-gray-600">Show off your dishes</div>
                        </div>
                    </label>
                    
                    <label class="flex items-start p-4 border-2 border-gray-200 rounded-xl hover:border-amber-500 cursor-pointer transition">
                        <input type="checkbox" id="feature-analytics" class="mt-1 mr-3" value="analytics">
                        <div>
                            <div class="font-bold text-gray-800">üìä Menu Analytics</div>
                            <div class="text-sm text-gray-600">Track popular items</div>
                        </div>
                    </label>
                    
                    <label class="flex items-start p-4 border-2 border-gray-200 rounded-xl hover:border-amber-500 cursor-pointer transition">
                        <input type="checkbox" id="feature-seasonal" class="mt-1 mr-3" value="seasonal">
                        <div>
                            <div class="font-bold text-gray-800">üçÇ Seasonal Menus</div>
                            <div class="text-sm text-gray-600">Easy menu rotation</div>
                        </div>
                    </label>
                    
                    <label class="flex items-start p-4 border-2 border-gray-200 rounded-xl hover:border-amber-500 cursor-pointer transition">
                        <input type="checkbox" id="feature-specials" class="mt-1 mr-3" value="specials">
                        <div>
                            <div class="font-bold text-gray-800">‚≠ê Daily Specials</div>
                            <div class="text-sm text-gray-600">Highlight featured items</div>
                        </div>
                    </label>
                </div>
                
                <div class="flex gap-4">
                    <button onclick="prevStep()" class="px-6 py-3 border-2 border-gray-300 text-gray-700 font-bold rounded-xl hover:bg-gray-50 transition">
                        ‚Üê Back
                    </button>
                    <button onclick="nextStep()" class="flex-1 px-6 py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold rounded-xl hover:shadow-lg transition">
                        Continue ‚Üí
                    </button>
                </div>
            </div>
            
            <!-- Step 4: Complete -->
            <div id="step-4" class="step-content">
                <div class="text-center">
                    <div class="text-6xl mb-6">üéâ</div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">You're All Set!</h2>
                    <p class="text-lg text-gray-600 mb-8">
                        Your account is ready. Let's create your first menu!
                    </p>
                    
                    <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl p-6 mb-8">
                        <h3 class="font-bold text-gray-800 mb-3">What's Next?</h3>
                        <ul class="text-left space-y-2 text-gray-700">
                            <li class="flex items-start">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>Add your menu items and categories</span>
                            </li>
                            <li class="flex items-start">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>Upload photos of your dishes</span>
                            </li>
                            <li class="flex items-start">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>Generate your QR code</span>
                            </li>
                            <li class="flex items-start">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>Print and display at your venue</span>
                            </li>
                        </ul>
                    </div>
                    
                    <button id="complete-btn" onclick="completeOnboarding()" class="px-8 py-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold rounded-xl hover:shadow-lg transition text-lg">
                        Go to Dashboard ‚Üí
                    </button>
                </div>
            </div>
            
        </div>
        
    </div>
    
    <script>
        let currentStep = 1;
        const totalSteps = 4;
        
        function updateStepIndicators() {
            for (let i = 1; i <= totalSteps; i++) {
                const indicator = document.getElementById(`step-${i}-indicator`);
                indicator.classList.remove('active', 'completed');
                
                if (i < currentStep) {
                    indicator.classList.add('completed');
                    indicator.innerHTML = '‚úì';
                } else if (i === currentStep) {
                    indicator.classList.add('active');
                    indicator.textContent = i;
                } else {
                    indicator.textContent = i;
                }
            }
        }
        
        function showStep(step) {
            // Hide all steps
            for (let i = 1; i <= totalSteps; i++) {
                document.getElementById(`step-${i}`).classList.remove('active');
            }
            
            // Show current step
            document.getElementById(`step-${step}`).classList.add('active');
            updateStepIndicators();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function nextStep() {
            // Validate current step
            if (currentStep === 2) {
                const cuisine = document.getElementById('cuisine-type').value;
                const price = document.getElementById('price-range').value;
                const size = document.getElementById('menu-size').value;
                
                if (!cuisine || !price || !size) {
                    alert('Please complete all fields before continuing');
                    return;
                }
            }
            
            if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
            }
        }
        
        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }
        
        async function completeOnboarding() {
            const button = document.getElementById('complete-btn');
            button.disabled = true;
            button.innerHTML = 'Completing... <svg class="inline animate-spin ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
            
            try {
                // Collect onboarding data
                const onboardingData = {
                    cuisine_type: document.getElementById('cuisine-type').value,
                    price_range: document.getElementById('price-range').value,
                    menu_size: document.getElementById('menu-size').value,
                    features: {
                        multilang: document.getElementById('feature-multilang').checked,
                        allergens: document.getElementById('feature-allergens').checked,
                        photos: document.getElementById('feature-photos').checked,
                        analytics: document.getElementById('feature-analytics').checked,
                        seasonal: document.getElementById('feature-seasonal').checked,
                        specials: document.getElementById('feature-specials').checked
                    }
                };
                
                console.log('Saving onboarding data:', onboardingData);
                
                // Mark onboarding as complete
                await window.MenuQRAuth.markOnboardingComplete(onboardingData);
                
                console.log('‚úÖ Onboarding complete!');
                
                // Redirect to dashboard
                window.location.href = 'dashboard.html';
                
            } catch (error) {
                console.error('Error completing onboarding:', error);
                alert('Error saving your preferences. Please try again.');
                button.disabled = false;
                button.innerHTML = 'Go to Dashboard ‚Üí';
            }
        }
        
        // Initialize
        showStep(1);
    </script>
    
</body>
</html>